___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "AdScout Pixel",
  "categories": ["AFFILIATE_MARKETING", "ADVERTISING", "REMARKETING"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "AdScout",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "This is an official Google Tag Manager template for the AdScout Pixel.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "partnerCode",
    "simpleValueType": true,
    "help": "Provided by AdScout",
    "displayName": "Partner Code Value",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "partnerToken",
    "displayName": "Partner Token Value",
    "simpleValueType": true,
    "help": "Provided by AdScout",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "debug",
    "checkboxText": "Log Debug messages to console",
    "simpleValueType": true
  },
  {
    "type": "LABEL",
    "name": "lineSeparator",
    "displayName": "Parameters Mapper"
  },
  {
    "type": "TEXT",
    "name": "fastOrderParamValue",
    "simpleValueType": true,
    "help": "If your store is using fast order option a param value needs to be provided in order the order type to be determined (example: \"Fast\")",
    "displayName": "Fast Order Value Mapper",
    "defaultValue": "Fast"
  },
  {
    "type": "TEXT",
    "name": "eventModelContainer",
    "displayName": "Event Model Data Container",
    "simpleValueType": true,
    "defaultValue": "eventModel",
    "help": "Enter the name of the container that holds the product/purchase data send from your store in the GTM data layer, you can get this value in \"Preview\" mode and send a test transaction.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "valueHint": "eventModel",
    "valueUnit": "(Examples: \"eventModel\", \"eventData\")"
  },
  {
    "type": "TEXT",
    "name": "productsObjectContainer",
    "displayName": "Products Object Container",
    "simpleValueType": true,
    "defaultValue": "items",
    "help": "This is a child property of the \"Event Model Container\" property, enter the name of the container that holds the products data send from your store in the GTM data layer, you can get this value in \"Preview\" mode and send a test transaction.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "valueHint": "items",
    "valueUnit": "(Examples: \"items\", \"products\")"
  },
  {
    "type": "TEXT",
    "name": "purchaseEventName",
    "displayName": "Purchase Event Name",
    "simpleValueType": true,
    "help": "Enter the event that is triggered when a purchase is initiated, you can get this value in \"Preview\" mode and send a test transaction.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "valueHint": "purchase",
    "defaultValue": "purchase",
    "valueUnit": "(Example: \"purchase\", \"order\")"
  },
  {
    "type": "TEXT",
    "name": "productCategory",
    "displayName": "Product Category Variable",
    "simpleValueType": true,
    "help": "Choose the pre-difined variable that points to the current category of your products/pages. The variable should be pre-defined with path to the current category (example: eventModel.items.0.category)",
    "valueHint": "{{AdScout Category}}",
    "valueUnit": "(Choose from your custom variables)"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Enter your template code here.
const logToConsole = require('logToConsole');
const copyFromDataLayer = require('copyFromDataLayer');
const queryPermission = require('queryPermission');
const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const callInWindow = require('callInWindow');
const sha256 = require('sha256');

// If the user chose to log debug output, initialize the logging method
const log = data.debug ? logToConsole : (() => {});
const items = data.productsObjectContainer;

const params = {
      eventType: 'PURCHASE',
      transaction: {
        orderType: 'n',
        purchaseToken: null,
        urlEncoded: data.partnerCode,
        category: null
      }
};

log('data =', data);
const appendAdScoutScript = 'https://adscout.io/adscout-script/'+data.partnerCode;

const mapProducts = products => {
  return products.map(i => {
       return {
         qty: i.quantity,
         id: i.id,
	     sp: i.price
       };
    });
};
const model = copyFromDataLayer(data.eventModelContainer) || {};
const eventType = copyFromDataLayer('event') || null;

log('event = ', eventType);
// If the script loaded successfully, log a message and signal success
const onSuccess = () => {
  log("MODEL", model);
  log('Conductrics: Script loaded successfully.');

  if (data.productCategory) {
    params.transaction.category = data.productCategory;
  }
  
  if(eventType === data.purchaseEventName && model.hasOwnProperty(items)){
    params.eventType = 'PURCHASE';
    params.transaction.currency = model.currency;
    params.transaction.amount = model.value;
    params.transaction.orderNumber = model.transaction_id;
    params.transaction.products = mapProducts(model[items]);
    if (model.affiliation.indexOf(data.fastOrderParamValue) !== -1){
       params.transaction.orderType = 'f';
    }
    
    log(params.transaction.products);
    
    sha256(data.partnerToken + params.transaction.orderNumber, (digest) => {
      params.transaction.purchaseToken = digest;
      log('purchaseToken= ', params.transaction.purchaseToken);
      
      setInWindow('_adscout', params, true); 
      callInWindow('AdScout.sendToApiPurchaseData');
    }, data.gtmOnFailure, {outputEncoding: 'hex'});
  }
  
  if(eventType === 'view_item' && model.hasOwnProperty(items)){
    params.eventType = 'PRODUCT_VIEW';
    params.products = mapProducts(model[items]);
    
    log(params.products);
    setInWindow('_adscout', params, true); 
  }

  if (data.debug){
    callInWindow('AdScout.testGTM');
  }
  
  data.gtmOnSuccess();
  
};

// If the script fails to load, log a message and signal failure
const onFailure = () => {
  log('Conductrics: Script load failed.');
  data.gtmOnFailure();
};

if (queryPermission('inject_script', appendAdScoutScript)) {
    injectScript(appendAdScoutScript, onSuccess, onFailure);
} else {
    log('Conductrics: Script load failed due to permissions mismatch.');  
    data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "eventModel.*"
              },
              {
                "type": 1,
                "string": "event"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://adscout.io/adscout-script/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_adscout"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "AdScout.sendToApiPurchaseData"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "AdScout.testGTM"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "AdScout.adsRef"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: InjectScript
  code: |-
    mock('copyFromDataLayer', (key) => {
      return dataLayer;
    });
    // Call runCode to run the template's code.
    runCode(mockData);


    // Verify that the tag finished successfully.
    assertApi('injectScript').wasCalled();
setup: |-
  const mockData = {
    debug: true,
    productsObjectContainer: 'items',
    partnerCode: 'aHR0cHMlM0ElMkYlMkZnbG9iYWxtYXJrZXQuYmc=',
    fastOrderParamValue: 'Fast',
  };

  const dataLayer = {
      currency: "BGN",
      transaction_id: "121212121",
      value: 100,
      affiliation: "Fast Order",
      items: [
        {
          id: "1234567890",
          name: "Test Product Name",
          brand: "Brand",
          category: "CategoryName",
          quantity: 10,
          price: 100,
          sku: "AAABBB111000"
        }
      ]
    };


___NOTES___

Created on 15/03/2022, 14:09:02


